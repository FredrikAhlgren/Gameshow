<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big Screen Display - Christmas Game Show</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <div class="sound-controls">
            <span style="font-size: 14px; color: #666;">Sound Effects:</span>
            <button class="sound-btn" id="soundToggle" onclick="toggleSound()" title="Toggle Sound">
                ðŸ”Š
            </button>
            <button class="sound-btn" onclick="playSound('buzzer')" title="Test Buzzer">
                ðŸ””
            </button>
            <button class="sound-btn" onclick="playSound('correct')" title="Test Correct">
                âœ“
            </button>
            <button class="sound-btn" onclick="playSound('wrong')" title="Test Wrong">
                âœ—
            </button>
        </div>

        <div class="screen-header">
            <h2>ðŸŽ„ CHRISTMAS GAMES ðŸŽ…</h2>
            <p id="connectionStatus">Connecting...</p>
        </div>

        <div class="buzzer-indicator" id="buzzerIndicator">
            ðŸ”” <strong id="buzzerTeamName">Team</strong> buzzed in! (<span id="buzzerPlayerName">Player</span>)
        </div>

        <div class="answer-overlay" id="answerOverlay">
            <div class="overlay-content" id="overlayContent">
                <div class="overlay-icon" id="overlayIcon">âœ“</div>
                <div class="overlay-text" id="overlayText">CORRECT!</div>
                <div class="overlay-subtext" id="overlaySubtext">+300 points</div>
            </div>
        </div>

        <div class="question-popup" id="questionPopup">
            <div class="popup-content">
                <div class="popup-category" id="popupCategory">CATEGORY</div>
                <div class="popup-value" id="popupValue">100</div>
                <div class="popup-question" id="popupQuestion">
                    Question text goes here
                </div>
                <div class="popup-timer" id="popupTimer">0:15</div>
            </div>
        </div>

        <div class="scoreboard" id="scoreboard">
            <!-- Teams will be populated here -->
        </div>

        <div class="game-board" id="gameBoard">
            <!-- Game board will be populated here -->
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- App Scripts -->
    <script src="/js/firebase-config.js"></script>
    <script src="/js/firebase-game.js"></script>
    <script src="/js/sound-effects.js"></script>
    <script>
        let gameState = null;
        let popupTimerInterval = null;
        let popupTimeLeft = 15;
        let previousCurrentQuestion = null;
        let previousBuzzer = null;

        // Initialize Firebase and game state
        initializeGameState().then(() => {
            console.log('Game state initialized');
        });

        // Listen for connection status
        onConnectionChange((connected) => {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.textContent = 'ðŸŸ¢ Connected';
                status.style.color = '#10b981';
            } else {
                status.textContent = 'ðŸ”´ Disconnected';
                status.style.color = '#ef4444';
            }
        });

        // Listen for game state changes
        onGameStateChange((state) => {
            const oldState = gameState;
            gameState = state;

            // Render scoreboard and board
            renderScoreboard();
            renderGameBoard();

            // Check if question was selected
            if (state.currentQuestion && (!previousCurrentQuestion ||
                state.currentQuestion.selectedAt !== previousCurrentQuestion.selectedAt)) {
                showQuestionPopup(state.currentQuestion);
                previousCurrentQuestion = state.currentQuestion;
            }

            // Check if question was closed
            if (!state.currentQuestion && previousCurrentQuestion) {
                closeQuestionPopup();
                previousCurrentQuestion = null;
            }

            // Check if someone buzzed in
            if (state.currentBuzzer && (!previousBuzzer ||
                state.currentBuzzer.timestamp !== previousBuzzer.timestamp)) {
                showBuzzerIndicator(state.currentBuzzer);
                previousBuzzer = state.currentBuzzer;
            }

            // Check if buzzer was reset
            if (!state.currentBuzzer && previousBuzzer) {
                hideBuzzerIndicator();
                previousBuzzer = null;
            }

            // Check for scoring changes (answer was judged)
            if (oldState && state.answerHistory.length > oldState.answerHistory.length) {
                const latestAnswer = state.answerHistory[0];
                showAnswerFeedback(latestAnswer);
            }
        });

        function showBuzzerIndicator(buzzer) {
            const indicator = document.getElementById('buzzerIndicator');
            const teamNameEl = document.getElementById('buzzerTeamName');
            const playerNameEl = document.getElementById('buzzerPlayerName');

            teamNameEl.textContent = buzzer.teamName;
            playerNameEl.textContent = buzzer.playerName;
            indicator.classList.remove('correct', 'incorrect');
            indicator.classList.add('active');

            playSound('buzzer');
        }

        function hideBuzzerIndicator() {
            const indicator = document.getElementById('buzzerIndicator');
            indicator.classList.remove('active', 'correct', 'incorrect');
        }

        function showAnswerFeedback(answer) {
            const indicator = document.getElementById('buzzerIndicator');

            if (answer.correct) {
                indicator.classList.add('correct');
                indicator.innerHTML = `âœ“ <strong>${answer.teamName}</strong> answered correctly! +${answer.points} points`;
                showAnswerOverlay(true, answer.teamName, answer.points);
                playSound('correct');

                // Spotlight effect
                setTimeout(() => {
                    const teamScores = document.querySelectorAll('.team-score');
                    const team = gameState.teams.find(t => t.name === answer.teamName);
                    if (team) {
                        const activeTeams = gameState.teams.filter(t => t.active);
                        const teamIndex = activeTeams.indexOf(team);
                        if (teamScores[teamIndex]) {
                            teamScores[teamIndex].classList.add('spotlight');
                            setTimeout(() => {
                                teamScores[teamIndex].classList.remove('spotlight');
                            }, 3000);
                        }
                    }
                }, 500);
            } else {
                indicator.classList.add('incorrect');
                indicator.innerHTML = `âœ— <strong>${answer.teamName}</strong> answered incorrectly`;
                showAnswerOverlay(false, answer.teamName);
                playSound('wrong');
            }

            setTimeout(() => {
                indicator.classList.remove('active', 'correct', 'incorrect');
            }, 3000);
        }

        function renderScoreboard() {
            const scoreboard = document.getElementById('scoreboard');
            if (!gameState) return;

            const activeTeams = gameState.teams.filter(t => t.active);
            scoreboard.innerHTML = activeTeams.map(team => `
                <div class="team-score" style="border-color: ${team.color}; color: ${team.color};">
                    <div class="team-avatar">
                        ${team.picture ? `<img src="${team.picture}" alt="${team.name}">` : team.icon}
                    </div>
                    <h3>${team.name.toUpperCase()}</h3>
                    <div class="score">${team.score.toLocaleString()}</div>
                </div>
            `).join('');
        }

        function renderGameBoard() {
            const board = document.getElementById('gameBoard');
            if (!gameState) return;

            let html = '';

            // Categories
            gameState.categories.forEach(category => {
                html += `<div class="category">${category}</div>`;
            });

            // Questions
            for (let value = 100; value <= 500; value += 100) {
                gameState.categories.forEach(category => {
                    const question = gameState.questions[category]?.find(q => q.value === value);
                    const answered = question ? question.answered : false;
                    const classes = answered ? 'question-cell answered' : 'question-cell';

                    html += `<div class="${classes}" onclick="handleSelectQuestion('${category}', ${value})">${value}</div>`;
                });
            }

            board.innerHTML = html;
        }

        function handleSelectQuestion(category, value) {
            const question = gameState.questions[category]?.find(q => q.value === value);
            if (question && !question.answered) {
                selectQuestion(category, value);
                playSound('click');
            }
        }

        function showQuestionPopup(question) {
            const popup = document.getElementById('questionPopup');
            const popupCategory = document.getElementById('popupCategory');
            const popupValue = document.getElementById('popupValue');
            const popupQuestion = document.getElementById('popupQuestion');

            popupCategory.textContent = question.category.toUpperCase();
            popupValue.textContent = question.value;
            popupQuestion.textContent = question.question;

            popup.classList.add('active');
            startPopupTimer();
        }

        function closeQuestionPopup() {
            const popup = document.getElementById('questionPopup');
            popup.classList.remove('active');
            clearInterval(popupTimerInterval);
        }

        function startPopupTimer() {
            clearInterval(popupTimerInterval);
            popupTimeLeft = 15;
            updatePopupTimer();

            popupTimerInterval = setInterval(() => {
                popupTimeLeft--;
                updatePopupTimer();

                if (popupTimeLeft <= 10 && popupTimeLeft > 0) {
                    playSound('timer');
                }

                if (popupTimeLeft === 0) {
                    clearInterval(popupTimerInterval);
                    playSound('wrong');
                    setTimeout(() => {
                        closeQuestion();
                    }, 1000);
                }
            }, 1000);
        }

        function updatePopupTimer() {
            const display = document.getElementById('popupTimer');
            display.textContent = `0:${popupTimeLeft.toString().padStart(2, '0')}`;

            if (popupTimeLeft <= 5) {
                display.classList.add('warning');
            } else {
                display.classList.remove('warning');
            }
        }

        function showAnswerOverlay(isCorrect, teamName, points = 0) {
            const overlay = document.getElementById('answerOverlay');
            const content = document.getElementById('overlayContent');
            const icon = document.getElementById('overlayIcon');
            const text = document.getElementById('overlayText');
            const subtext = document.getElementById('overlaySubtext');

            if (isCorrect) {
                content.className = 'overlay-content correct';
                icon.textContent = 'âœ“';
                text.textContent = 'CORRECT!';
                subtext.textContent = `${teamName} +${points} points`;
            } else {
                content.className = 'overlay-content incorrect';
                icon.textContent = 'âœ—';
                text.textContent = 'INCORRECT!';
                subtext.textContent = `${teamName} - No points awarded`;
            }

            overlay.classList.add('active');

            setTimeout(() => {
                overlay.classList.remove('active');
            }, 3000);
        }
    </script>
</body>
</html>
