<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Buzzer - Christmas Game Show</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container mobile-buzzer">
        <div class="phone-frame">
            <div class="mobile-header">
                <h2>Christmas Games Buzzer</h2>
                <p id="connectionStatus">Connecting...</p>
            </div>

            <div class="player-name-input">
                <label>Your Name:</label>
                <input type="text" id="playerName" placeholder="Enter your name" value="">
            </div>

            <div class="team-selector">
                <label>Select Your Team:</label>
                <select id="teamSelect">
                    <option value="">-- Select Team --</option>
                </select>
            </div>

            <div class="buzzer-container">
                <button class="buzzer-button locked" id="buzzerButton" onclick="handleBuzzerPress()">
                    BUZZ!
                </button>
            </div>

            <div class="buzzer-status" id="buzzerStatus">
                <p><strong>Status:</strong> Select your team to begin</p>
                <p style="margin-top: 10px; font-size: 14px; color: #999;">
                    ‚è≥ Waiting...
                </p>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- App Scripts -->
    <script src="/js/firebase-config.js"></script>
    <script src="/js/firebase-game.js"></script>
    <script src="/js/sound-effects.js"></script>
    <script>
        let gameState = null;
        let selectedTeamId = null;
        let buzzerLocked = true;

        // Initialize Firebase and game state
        initializeGameState().then(() => {
            console.log('Game state initialized');
        });

        // Listen for connection status
        onConnectionChange((connected) => {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.textContent = 'üü¢ Connected';
                status.style.color = '#10b981';
            } else {
                status.textContent = 'üî¥ Disconnected';
                status.style.color = '#ef4444';
            }
        });

        // Listen for game state changes
        onGameStateChange((state) => {
            gameState = state;
            populateTeamSelect();
            updateBuzzerStatus();
            checkAnswerResult();
        });

        function populateTeamSelect() {
            const select = document.getElementById('teamSelect');
            if (!gameState) return;

            const activeTeams = gameState.teams.filter(t => t.active);
            select.innerHTML = '<option value="">-- Select Team --</option>' +
                activeTeams.map(team =>
                    `<option value="${team.id}">${team.icon} ${team.name}</option>`
                ).join('');

            // Restore selection
            if (selectedTeamId) {
                select.value = selectedTeamId;
            }
        }

        function updateBuzzerStatus() {
            const button = document.getElementById('buzzerButton');

            if (!selectedTeamId) {
                buzzerLocked = true;
                updateStatus('Select your team to begin', '#999');
            } else if (!gameState?.currentQuestion) {
                buzzerLocked = true;
                updateStatus('Waiting for next question...', '#999');
            } else if (gameState.buzzerLocked) {
                buzzerLocked = true;
                if (gameState.currentBuzzer) {
                    const myTeam = gameState.teams.find(t => t.id === selectedTeamId);
                    const playerName = document.getElementById('playerName').value || 'Anonymous';

                    if (gameState.currentBuzzer.teamName === myTeam?.name &&
                        gameState.currentBuzzer.playerName === playerName) {
                        updateStatus('You buzzed in! Waiting for judge...', '#f59e0b');
                    } else {
                        updateStatus(`${gameState.currentBuzzer.teamName} (${gameState.currentBuzzer.playerName}) buzzed in first!`, '#ef4444');
                    }
                }
            } else {
                buzzerLocked = false;
                updateStatus('Ready to buzz in!', '#10b981');
            }

            updateBuzzerButton();
        }

        function updateBuzzerButton() {
            const button = document.getElementById('buzzerButton');
            if (buzzerLocked || !selectedTeamId) {
                button.classList.add('locked');
            } else {
                button.classList.remove('locked');
            }
        }

        function updateStatus(message, color = '#999') {
            const status = document.getElementById('buzzerStatus');
            const icon = buzzerLocked ? '‚è≥' : '‚úì';
            const iconColor = buzzerLocked ? '#999' : '#10b981';

            status.innerHTML = `
                <p><strong>Status:</strong> ${message}</p>
                <p style="margin-top: 10px; font-size: 14px; color: ${iconColor};">
                    ${icon} ${buzzerLocked ? 'Buzzer Locked' : 'Buzzer Active ‚Ä¢ Vibration Enabled'}
                </p>
            `;
        }

        function checkAnswerResult() {
            if (!gameState || !gameState.answerHistory || gameState.answerHistory.length === 0) return;

            const myTeam = gameState.teams.find(t => t.id === selectedTeamId);
            if (!myTeam) return;

            const latestAnswer = gameState.answerHistory[0];
            if (latestAnswer.teamName === myTeam.name) {
                // Check if this is a new answer (not already processed)
                const now = Date.now();
                if (now - latestAnswer.timestamp < 3000) {
                    if (latestAnswer.correct) {
                        updateStatus(`Correct! +${latestAnswer.points} points!`, '#10b981');
                        playSound('correct');
                    } else {
                        updateStatus('Incorrect. Better luck next time!', '#ef4444');
                        playSound('wrong');
                    }
                }
            }
        }

        function handleBuzzerPress() {
            if (buzzerLocked || !selectedTeamId) {
                return;
            }

            const playerName = document.getElementById('playerName').value || 'Anonymous';
            const selectedTeam = gameState.teams.find(t => t.id === selectedTeamId);

            if (!selectedTeam) {
                alert('Please select a team first!');
                return;
            }

            // Send buzzer press to Firebase
            pressBuzzer(selectedTeam.id, selectedTeam.name, playerName);

            // Vibration feedback
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }

            // Play local sound
            playSound('buzzer');

            // Update UI immediately
            buzzerLocked = true;
            updateBuzzerButton();
            updateStatus('Buzzed in! Waiting for judge...', '#f59e0b');
        }

        // Team selection change
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('teamSelect').addEventListener('change', (e) => {
                selectedTeamId = parseInt(e.target.value) || null;
                updateBuzzerStatus();
            });

            // Save/restore player name
            const nameInput = document.getElementById('playerName');
            const savedName = localStorage.getItem('playerName');
            if (savedName) {
                nameInput.value = savedName;
            }

            nameInput.addEventListener('input', (e) => {
                localStorage.setItem('playerName', e.target.value);
            });
        });
    </script>
</body>
</html>
